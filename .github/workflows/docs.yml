# Build Sphinx docs for picoio (latest + version switcher from tags).

name: Docs

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "docs"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libzip-dev

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.14

      - name: Build docs for all versions
        env:
          DOC_VERSIONS_LIST: ""
          GITHUB_PAGES_BASE: /${{ github.event.repository.name }}
        run: |
          set -e
          mkdir -p site

          # Version list for switcher: latest + recent tags (max 10)
          TAGS=$(git tag -l 'v*' 2>/dev/null | sort -V | tail -10)
          if [ -z "$TAGS" ]; then
            TAGS=$(git tag -l '[0-9]*.*' 2>/dev/null | sort -V | tail -10)
          fi
          VERS="latest"
          for tag in $TAGS; do VERS="$VERS ${tag#v}"; done
          DOC_VERSIONS_LIST=$(echo "$VERS" | tr ' ' ',' | sed 's/,,*/,/g; s/^,//')

          # Build latest from current ref (main) only when docs exist
          if [ -d docs ] && [ -f docs/conf.py ]; then
            export CURRENT_DOC_VERSION=latest
            export DOC_VERSIONS="$DOC_VERSIONS_LIST"
            export GITHUB_PAGES_BASE
            uv sync --extra dev
            uv pip install -e .
            uv run python -m sphinx -b html docs docs/_build/html
            cp -r docs/_build/html site/latest
          fi

          # Build each recent tag (v*); return to main after each tag
          ORIG_REF=$(git rev-parse HEAD)
          for tag in $TAGS; do
            ver=${tag#v}
            git checkout "$tag" 2>/dev/null || true
            if [ -d docs ] && [ -f docs/conf.py ]; then
              export CURRENT_DOC_VERSION="$ver"
              export DOC_VERSIONS="$DOC_VERSIONS_LIST"
              export GITHUB_PAGES_BASE
              uv sync --extra dev 2>/dev/null || true
              uv pip install -e . 2>/dev/null || true
              uv run python -m sphinx -b html docs docs/_build/html 2>/dev/null || true
              mkdir -p "site/$ver"
              cp -r docs/_build/html/* "site/$ver/"
            fi
            git checkout "$ORIG_REF"
          done

          # Root index: version picker + redirect to latest
          VERS=$(for d in site/*/; do [ -d "$d" ] && basename "$d"; done | sort -Vr)
          {
            echo '<!DOCTYPE html><html><head><meta charset="utf-8">'
            echo '<meta http-equiv="refresh" content="0; url=latest/">'
            echo '<title>picoio</title>'
            echo '<style>body{font-family:system-ui,sans-serif;max-width:40em;margin:2em auto;padding:0 1em;line-height:1.5}a{color:#2980b9}ul{list-style:none;padding:0}li{margin:.5em 0}</style></head><body>'
            echo '<h1>picoio</h1><p>Redirecting to <a href="latest/">latest</a>â€¦</p><p>Versions:</p><ul>'
            for v in $VERS; do echo "<li><a href=\"$v/\">$v</a></li>"; done
            echo '</ul></body></html>'
          } > site/index.html

      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - name: Deploy
        id: deploy
        uses: actions/deploy-pages@v4
